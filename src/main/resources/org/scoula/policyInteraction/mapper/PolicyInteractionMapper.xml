<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.scoula.policyInteraction.mapper.PolicyInteractionMapper">

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- ðŸ“Œ ì •ì±… ë¶ë§ˆí¬ ê´€ë ¨ -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

    <!-- ë¶ë§ˆí¬ ë“±ë¡ (created_atì€ DBì—ì„œ NOW() ì²˜ë¦¬) -->
    <insert id="insertBookmark" parameterType="org.scoula.policyInteraction.domain.YouthPolicyBookmarkVO">
        INSERT INTO youth_policy_bookmark (user_id, policy_id, created_at)
        VALUES (#{userId}, #{policyId}, NOW())
    </insert>

    <!-- ë¶ë§ˆí¬ ì‚­ì œ -->
    <delete id="deleteBookmark">
        DELETE FROM youth_policy_bookmark
        WHERE user_id = #{userId} AND policy_id = #{policyId}
    </delete>

    <!-- íŠ¹ì • ë¶ë§ˆí¬ ë‹¨ê±´ ì¡°íšŒ -->
    <select id="selectBookmark" resultType="org.scoula.policyInteraction.domain.YouthPolicyBookmarkVO">
        SELECT
            id,
            user_id AS userId,
            policy_id AS policyId,
            created_at AS createdAt
        FROM youth_policy_bookmark
        WHERE user_id = #{userId} AND policy_id = #{policyId}
    </select>

    <!-- ì‚¬ìš©ìž ì „ì²´ ë¶ë§ˆí¬ ëª©ë¡ ì¡°íšŒ (ì •ì±… ì •ë³´ í¬í•¨) -->
    <select id="selectBookmarksByUserId" resultType="org.scoula.policyInteraction.dto.response.BookmarkWithPolicyDTO">
        SELECT 
            b.id as bookmarkId,
            b.created_at as bookmarkedAt,
            p.id as policyId,
            p.title,
            p.description,
            p.policy_benefit_description as policyBenefitDescription,
            pp.apply_period as applyPeriod,
            p.policy_benefit_amount as policyBenefitAmount
        FROM youth_policy_bookmark b
        INNER JOIN youth_policy p ON b.policy_id = p.id
        LEFT JOIN youth_policy_period pp ON p.id = pp.policy_id
        WHERE b.user_id = #{userId}
        ORDER BY b.created_at DESC
    </select>

    <!-- ëª¨ë“  ë¶ë§ˆí¬ ëª©ë¡ ì¡°íšŒ (ì•Œë¦¼ ë°œì†¡ìš©) -->
    <select id="getAllBookmarks" resultType="org.scoula.policyInteraction.domain.YouthPolicyBookmarkVO">
        SELECT
            id,
            user_id AS userId,
            policy_id AS policyId,
            created_at AS createdAt
        FROM youth_policy_bookmark
        ORDER BY created_at DESC
    </select>

    <!-- ë¶ë§ˆí¬ ì•Œë¦¼ì„ êµ¬ë…í•œ ì‚¬ìš©ìžì˜ ë¶ë§ˆí¬ë§Œ ì¡°íšŒ (ìµœì í™”ëœ ì•Œë¦¼ ë°œì†¡ìš©) -->
    <select id="getBookmarksWithActiveSubscription" resultType="org.scoula.policyInteraction.domain.YouthPolicyBookmarkVO">
        SELECT DISTINCT
            b.id,
            b.user_id AS userId,
            b.policy_id AS policyId,
            b.created_at AS createdAt
        FROM youth_policy_bookmark b
        INNER JOIN subscription s ON b.user_id = s.user_id
        WHERE s.is_active_bookmark = true
        ORDER BY b.created_at DESC
    </select>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- ðŸ“Œ ì •ì±… ì‹ ì²­ ê´€ë ¨ -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

    <!-- ì •ì±… ì‹ ì²­ ë“±ë¡ (created_at, updated_atì€ DBì—ì„œ NOW() ì²˜ë¦¬) -->
    <insert id="insertApplication" parameterType="org.scoula.policyInteraction.domain.UserPolicyApplicationVO">
        INSERT INTO user_policy_application (user_id, policy_id, application_url, is_applied, benefit_status, created_at, updated_at)
        VALUES (#{userId}, #{policyId}, #{applicationUrl}, #{isApplied}, #{benefitStatus}, NOW(), NOW())
    </insert>

    <!-- íŠ¹ì • ì •ì±… ì‹ ì²­ ë‹¨ê±´ ì¡°íšŒ -->
    <select id="selectApplication" resultType="org.scoula.policyInteraction.domain.UserPolicyApplicationVO">
        SELECT
            id,
            user_id AS userId,
            policy_id AS policyId,
            application_url AS applicationUrl,
            is_applied AS isApplied,
            benefit_status AS benefitStatus,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM user_policy_application
        WHERE user_id = #{userId} AND policy_id = #{policyId}
    </select>

    <!-- ì‚¬ìš©ìž ì „ì²´ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ (ì •ì±… ì •ë³´ í¬í•¨) -->
    <select id="selectApplicationsByUserId" resultType="org.scoula.policyInteraction.dto.response.ApplicationWithPolicyDTO">
        SELECT 
            a.id as applicationId,
            a.is_applied as isApplied,
            a.benefit_status as benefitStatus,
            a.created_at as appliedAt,
            p.id as policyId,
            p.title,
            p.description,
            p.policy_benefit_description as policyBenefitDescription,
            pp.apply_period as applyPeriod,
            p.policy_benefit_amount as policyBenefitAmount
        FROM user_policy_application a
        INNER JOIN youth_policy p ON a.policy_id = p.id
        LEFT JOIN youth_policy_period pp ON p.id = pp.policy_id
        WHERE a.user_id = #{userId}
        ORDER BY a.created_at DESC
    </select>

    <!-- ì •ì±… ì‹ ì²­ ì™„ë£Œ ì²˜ë¦¬ (is_appliedë¥¼ trueë¡œ ë³€ê²½) -->
    <update id="updateApplicationToComplete">
        UPDATE user_policy_application 
        SET is_applied = TRUE, updated_at = NOW()
        WHERE user_id = #{userId} AND policy_id = #{policyId}
    </update>

    <!-- ì •ì±… ì‹ ì²­ ê¸°ë¡ ì‚­ì œ -->
    <delete id="deleteApplication">
        DELETE FROM user_policy_application
        WHERE user_id = #{userId} AND policy_id = #{policyId}
    </delete>

    <!-- í˜œíƒ ìˆ˜ë ¹ ìƒíƒœ ì—…ë°ì´íŠ¸ -->
    <update id="updateBenefitStatus">
        UPDATE user_policy_application
        SET benefit_status = #{benefitStatus}, updated_at = NOW()
        WHERE user_id = #{userId} AND policy_id = #{policyId}
    </update>

    <!-- ë¯¸ì™„ë£Œ ì‹ ì²­ ì •ì±… í•˜ë‚˜ ì¡°íšŒ (is_applied = false) -->
    <select id="findIncompleteApplication" resultType="org.scoula.policyInteraction.dto.response.ApplicationWithPolicyDTO">
        SELECT 
            a.id as applicationId,
            a.is_applied as isApplied,
            a.benefit_status as benefitStatus,
            a.created_at as appliedAt,
            p.id as policyId,
            p.title,
            p.description,
            p.policy_benefit_description as policyBenefitDescription,
            pp.apply_period as applyPeriod,
            p.policy_benefit_amount as policyBenefitAmount
        FROM user_policy_application a
        INNER JOIN youth_policy p ON a.policy_id = p.id
        LEFT JOIN youth_policy_period pp ON p.id = pp.policy_id
        WHERE a.user_id = #{userId} AND a.is_applied = FALSE
        ORDER BY a.created_at ASC
        LIMIT 1
    </select>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- ðŸ“Œ ì •ì±… ë¦¬ë·° ê´€ë ¨ -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

    <!-- ë¦¬ë·° ë“±ë¡ -->
    <insert id="insertReview" parameterType="org.scoula.policyInteraction.domain.UserPolicyReviewVO">
        INSERT INTO user_policy_review (policy_id, user_id, like_count, benefit_status, content, created_at, updated_at)
        VALUES (#{policyId}, #{userId}, 0, #{benefitStatus}, #{content}, NOW(), NOW())
    </insert>

    <!-- ë¦¬ë·° ìˆ˜ì • -->
    <update id="updateReview" parameterType="org.scoula.policyInteraction.domain.UserPolicyReviewVO">
        UPDATE user_policy_review
        SET content = #{content},
            updated_at = NOW()
        WHERE user_id = #{userId} AND policy_id = #{policyId} AND benefit_status = #{benefitStatus}
    </update>

    <!-- ë¦¬ë·° ì‚­ì œ -->
    <delete id="deleteReview">
        DELETE FROM user_policy_review
        WHERE user_id = #{userId} AND policy_id = #{policyId} AND benefit_status = #{benefitStatus}
    </delete>

    <!-- ì‚¬ìš©ìžì˜ íŠ¹ì • ì •ì±… ë¦¬ë·° ì¡°íšŒ -->
    <select id="selectReviewByUserAndPolicy" resultType="org.scoula.policyInteraction.domain.UserPolicyReviewVO">
        SELECT
            id,
            policy_id AS policyId,
            user_id AS userId,
            like_count AS likeCount,
            benefit_status AS benefitStatus,
            content,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM user_policy_review
        WHERE user_id = #{userId} AND policy_id = #{policyId} AND benefit_status = #{benefitStatus}
    </select>

    <!-- ì •ì±…ë³„ ëª¨ë“  ë¦¬ë·° ì¡°íšŒ (ì‚¬ìš©ìž ì •ë³´ í¬í•¨) -->
    <select id="selectReviewsByPolicyId" resultType="org.scoula.policyInteraction.dto.response.ReviewWithUserDTO">
        SELECT
            r.id AS reviewId,
            r.like_count AS likeCount,
            r.benefit_status AS benefitStatus,
            r.content,
            r.created_at AS createdAt,
            r.updated_at AS updatedAt,
            r.user_id AS userId,
            u.name AS userName,
            u.profile_image_id AS profileImageId
        FROM user_policy_review r
        INNER JOIN users u ON r.user_id = u.user_id
        WHERE r.policy_id = #{policyId}
        ORDER BY r.created_at DESC
    </select>

    <!-- ì •ì±…ë³„ ë¦¬ë·° ìˆ˜ ì¡°íšŒ -->
    <select id="selectReviewCountByPolicyId" resultType="java.lang.Integer">
        SELECT COUNT(*) AS reviewCount
        FROM user_policy_review
        WHERE policy_id = #{policyId}
    </select>

    <!-- ì‚¬ìš©ìžê°€ ìž‘ì„±í•œ ëª¨ë“  ë¦¬ë·° ì¡°íšŒ (ì •ì±… ì •ë³´ í¬í•¨) -->
    <select id="selectReviewsByUserId" resultType="org.scoula.policyInteraction.dto.response.ReviewWithPolicyDTO">
        SELECT
            r.id AS reviewId,
            r.user_id AS userId,
            u.name AS userName,
            u.profile_image_id AS profileImageId,
            r.like_count AS likeCount,
            r.benefit_status AS benefitStatus,
            r.content,
            r.created_at AS createdAt,
            r.updated_at AS updatedAt,
            p.id AS policyId,
            p.title AS policyTitle,
            p.description AS policyDescription,
            p.policy_benefit_description AS policyBenefitDescription,
            pp.apply_period AS applyPeriod,
            p.policy_benefit_amount AS policyBenefitAmount
        FROM user_policy_review r
        INNER JOIN youth_policy p ON r.policy_id = p.id
        INNER JOIN users u ON r.user_id = u.user_id
        LEFT JOIN youth_policy_period pp ON p.id = pp.policy_id
        WHERE r.user_id = #{userId}
        ORDER BY r.created_at DESC
    </select>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- ðŸ“Œ ì¢‹ì•„ìš” ì‹œìŠ¤í…œ ê´€ë ¨ (í•˜ì´ë¸Œë¦¬ë“œ: Redis + DB ë™ê¸°í™”) -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->

    <!-- ë¦¬ë·° ì¢‹ì•„ìš” ìˆ˜ ì¦ê°€ (DB ë™ê¸°í™”ìš©) -->
    <update id="incrementReviewLikeCount">
        UPDATE user_policy_review 
        SET like_count = like_count + 1,
            updated_at = NOW()
        WHERE id = #{reviewId}
    </update>

    <!-- ë¦¬ë·° ì¢‹ì•„ìš” ìˆ˜ ê°ì†Œ (DB ë™ê¸°í™”ìš©, 0 ë¯¸ë§Œìœ¼ë¡œ ë‚´ë ¤ê°€ì§€ ì•Šë„ë¡ ì²˜ë¦¬) -->
    <update id="decrementReviewLikeCount">
        UPDATE user_policy_review 
        SET like_count = GREATEST(like_count - 1, 0),
            updated_at = NOW()
        WHERE id = #{reviewId}
    </update>

</mapper>
